<html lang="en"><head><script>(function(firebaseConfig, initialAuthToken, appId) {
        window.__firebase_config = firebaseConfig;
        window.__initial_auth_token = initialAuthToken;
        window.__app_id = appId;
            })("\n{\n  \"apiKey\": \"AIzaSyCqyCcs2R2e7AegGjvFAwG98wlamtbHvZY\",\n  \"authDomain\": \"bard-frontend.firebaseapp.com\",\n  \"projectId\": \"bard-frontend\",\n  \"storageBucket\": \"bard-frontend.firebasestorage.app\",\n  \"messagingSenderId\": \"175205271074\",\n  \"appId\": \"1:175205271074:web:2b7bd4d34d33bf38e6ec7b\"\n}\n","eyJhbGciOiJSUzI1NiIsImtpZCI6ImIxZjQyNzYzZjkzNGExOTQwMWNkOTFhNjdjY2FhNzdiNjIwNWU2N2EiLCJ0eXAiOiJKV1QifQ.eyJzdWIiOiJmaXJlYmFzZS1hZG1pbnNkay1mYnN2Y0BiYXJkLWZyb250ZW5kLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwiYXVkIjoiaHR0cHM6Ly9pZGVudGl0eXRvb2xraXQuZ29vZ2xlYXBpcy5jb20vZ29vZ2xlLmlkZW50aXR5LmlkZW50aXR5dG9vbGtpdC52MS5JZGVudGl0eVRvb2xraXQiLCJ1aWQiOiIwMTI5NTYxNjk5Njg0NDg5ODMxMSIsImlzcyI6ImZpcmViYXNlLWFkbWluc2RrLWZic3ZjQGJhcmQtZnJvbnRlbmQuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLCJjbGFpbXMiOnsiYXBwSWQiOiIyMTkxNTU0N2Q5NzQtd2Fsa3Rocm91Z2guaHRtbC0yNDIifSwiZXhwIjoxNzcwMTI3NTA4LCJpYXQiOjE3NzAxMjM5MDgsImFsZyI6IlJTMjU2In0.E-ygXXC3o6jxZhwS3Vd_H7lBkxsdKamuDK8WONYPIVxgBTIA2DdV0wvmI1ZpECRqlPdYhGLc_T6TG2IHup37yzIX3LQaO4xciHu30JQBRCxg0oZlwhiUm2Ot2vrpL2gpXrAFaY4iVbWihSm4ioOdLlK5ijGNIzA5wPo1u3b4T2R5lihTfpRJ2ACnUIhXNyPpOheLM6P0Vzyu0M9GNYhtm9C4skJANx2hFtf2-xCuHmyK8p2kAI-Gb4NzFh7ZwWqy7T0bnAq5Y7re4BBOoCLDV-Yqi0cTPUi7ud3IGJhWEpbDuU0fFVwPwdHcXxPsGuNGf0OTIemfjio57eBFTf_4pg","21915547d974-walkthrough.html-242")</script><script>'use strict';var h=typeof Object.defineProperties=="function"?Object.defineProperty:function(a,b,d){if(a==Array.prototype||a==Object.prototype)return a;a[b]=d.value;return a};function l(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var d=a[b];if(d&&d.Math==Math)return d}throw Error("Cannot find global object");}var n=l(this);
function p(a,b){if(b)a:{var d=n;a=a.split(".");for(var c=0;c<a.length-1;c++){var e=a[c];if(!(e in d))break a;d=d[e]}a=a[a.length-1];c=d[a];b=b(c);b!=c&&b!=null&&h(d,a,{configurable:!0,writable:!0,value:b})}}function r(a){function b(c){return a.next(c)}function d(c){return a.throw(c)}return new Promise(function(c,e){function f(g){g.done?c(g.value):Promise.resolve(g.value).then(b,d).then(f,e)}f(a.next())})}function t(a){return r(a())}
p("Object.values",function(a){return a?a:function(b){var d=[],c;for(c in b)Object.prototype.hasOwnProperty.call(b,c)&&d.push(b[c]);return d}});p("Array.prototype.includes",function(a){return a?a:function(b,d){var c=this;c instanceof String&&(c=String(c));var e=c.length;d=d||0;for(d<0&&(d=Math.max(d+e,0));d<e;d++){var f=c[d];if(f===b||Object.is(f,b))return!0}return!1}});/*

 MIT License

 Copyright (c) 2017-2023 W.Y.

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 SOFTWARE.

*/
function u(a,b){const d=a.style;b.backgroundColor&&(d.backgroundColor=b.backgroundColor);b.width&&(d.width=`${b.width}px`);b.height&&(d.height=`${b.height}px`);const c=b.style;c!=null&&Object.keys(c).forEach(e=>{d[e]=c[e]})};var v=(()=>{let a=0;return()=>{a+=1;return`u${`0000${(Math.random()*1679616<<0).toString(36)}`.slice(-4)}${a}`}})();function w(a){const b=[];for(let d=0,c=a.length;d<c;d++)b.push(a[d]);return b}let x=null;function y(a={}){return x?x:a.l?x=a.l:x=w(window.getComputedStyle(document.documentElement))}function z(a,b){return(a=(a.ownerDocument.defaultView||window).getComputedStyle(a).getPropertyValue(b))?parseFloat(a.replace("px","")):0}
function A(a,b={}){var d;if(!(d=b.width)){d=z(a,"border-left-width");var c=z(a,"border-right-width");d=a.clientWidth+d+c}(b=b.height)||(b=z(a,"border-top-width"),c=z(a,"border-bottom-width"),b=a.clientHeight+b+c);return{width:d,height:b}}function B(a){return new Promise((b,d)=>{const c=new Image;c.onload=()=>{c.decode().then(()=>{requestAnimationFrame(()=>b(c))})};c.onerror=d;c.crossOrigin="anonymous";c.decoding="async";c.src=a})}
function C(a){return t(function*(){return Promise.resolve().then(()=>(new XMLSerializer).serializeToString(a)).then(encodeURIComponent).then(b=>`data:image/svg+xml;charset=utf-8,${b}`)})}
function D(a,b,d){return t(function*(){const c=document.createElementNS("http://www.w3.org/2000/svg","svg"),e=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");c.setAttribute("width",`${b}`);c.setAttribute("height",`${d}`);c.setAttribute("viewBox",`0 0 ${b} ${d}`);e.setAttribute("width","100%");e.setAttribute("height","100%");e.setAttribute("x","0");e.setAttribute("y","0");e.setAttribute("externalResourcesRequired","true");c.appendChild(e);e.appendChild(a);return C(c)})}
var E=(a,b)=>{if(a instanceof b)return!0;a=Object.getPrototypeOf(a);return a===null?!1:a.constructor.name===b.name||E(a,b)};function F(a,b){return y(b).map(d=>{const c=a.getPropertyValue(d),e=a.getPropertyPriority(d);return`${d}: ${c}${e?" !important":""};`}).join(" ")}
function G(a,b,d,c){a=window.getComputedStyle(a,d);var e=a.getPropertyValue("content");if(e!==""&&e!=="none"){var f=v();try{b.className=`${b.className} ${f}`}catch(k){return}e=document.createElement("style");var g=e.appendChild;d=`.${f}:${d}`;a.cssText?(c=a.getPropertyValue("content"),c=`${a.cssText} content: '${c.replace(/'|"/g,"")}';`):c=F(a,c);g.call(e,document.createTextNode(`${d}{${c}}`));b.appendChild(e)}};function H(a){return a.search(/^(data:)/)!==-1}function I(a,b,d){return t(function*(){const c=yield fetch(a,b);if(c.status===404)throw Error(`Resource "${c.url}" not found`);const e=yield c.blob();return new Promise((f,g)=>{const k=new FileReader;k.onerror=g;k.onloadend=()=>{try{f(d({o:c,result:k.result}))}catch(m){g(m)}};k.readAsDataURL(e)})})}const J={};function K(a,b,d){let c=a.replace(/\?.*/,"");d&&(c=a);/ttf|otf|eot|woff2?/i.test(c)&&(c=c.replace(/.*\//,""));return b?`[${b}]${c}`:c}
function L(a,b,d){return t(function*(){const c=K(a,b,d.C);if(J[c]!=null)return J[c];d.u&&(a+=(/\?/.test(a)?"&":"?")+(new Date).getTime());let e;try{const f=yield I(a,d.i,({o:g,result:k})=>{b||(b=g.headers.get("Content-Type")||"");return k.split(/,/)[1]});e=`data:${b};base64,${f}`}catch(f){e=d.B||""}return J[c]=e})};const M={P:"application/font-woff",R:"application/font-woff",N:"application/font-truetype",v:"application/vnd.ms-fontobject",H:"image/png",F:"image/jpeg",D:"image/jpeg",A:"image/gif",M:"image/tiff",L:"image/svg+xml",O:"image/webp"};function N(a){return(a=/\.([^./]*?)$/g.exec(a))?a[1]:""};function O(a){return t(function*(){const b=a.toDataURL();return b==="data:,"?a.cloneNode(!1):B(b)})}function aa(a,b){return t(function*(){if(a.currentSrc){var d=document.createElement("canvas");const c=d.getContext("2d");d.width=a.clientWidth;d.height=a.clientHeight;c==null||c.drawImage(a,0,0,d.width,d.height);d=d.toDataURL();return B(d)}d=a.poster;d=yield L(d,M[N(d).toLowerCase()]||"",b);return B(d)})}
function ba(a,b){return t(function*(){try{let d;if(a==null?0:(d=a.contentDocument)==null?0:d.body)return yield P(a.contentDocument.body,b,!0)}catch(d){}return a.cloneNode(!1)})}function ca(a,b){return t(function*(){return E(a,HTMLCanvasElement)?O(a):E(a,HTMLVideoElement)?aa(a,b):E(a,HTMLIFrameElement)?ba(a,b):a.cloneNode(a.tagName!=null&&a.tagName.toUpperCase()==="SVG")})}
function da(a,b,d){return t(function*(){if(b.tagName!=null&&b.tagName.toUpperCase()==="SVG")return b;let c=[];if(a.tagName!=null&&a.tagName.toUpperCase()==="SLOT"&&a.assignedNodes)c=w(a.assignedNodes());else{let e;if(E(a,HTMLIFrameElement)&&((e=a.contentDocument)==null?0:e.body))c=w(a.contentDocument.body.childNodes);else{let f;c=w(((f=a.shadowRoot)!=null?f:a).childNodes)}}if(c.length===0||E(a,HTMLVideoElement))return b;yield c.reduce((e,f)=>e.then(()=>P(f,d)).then(g=>{g&&b.appendChild(g)}),Promise.resolve());
return b})}function ea(a,b,d){const c=b.style;if(c){var e=window.getComputedStyle(a);e.cssText?(c.cssText=e.cssText,c.transformOrigin=e.transformOrigin):y(d).forEach(f=>{let g=e.getPropertyValue(f);f==="font-size"&&g.endsWith("px")&&(g=`${Math.floor(parseFloat(g.substring(0,g.length-2)))-.1}px`);E(a,HTMLIFrameElement)&&f==="display"&&g==="inline"&&(g="block");f==="d"&&b.getAttribute("d")&&(g=`path(${b.getAttribute("d")})`);c.setProperty(f,g,e.getPropertyPriority(f))})}}
function fa(a,b){E(a,HTMLSelectElement)&&(b=Array.from(b.children).find(d=>a.value===d.getAttribute("value")))&&b.setAttribute("selected","")}
function ha(a,b){return t(function*(){var d=a.querySelectorAll?a.querySelectorAll("use"):[];if(d.length===0)return a;var c={};for(var e=0;e<d.length;e++){var f=d[e].getAttribute("xlink:href");if(f){const g=document.querySelector(f);a.querySelector(f)||!g||c[f]||(c[f]=yield P(g,b,!0))}}d=Object.values(c);if(d.length){c=document.createElementNS("http://www.w3.org/1999/xhtml","svg");c.setAttribute("xmlns","http://www.w3.org/1999/xhtml");c.style.position="absolute";c.style.width="0";c.style.height="0";
c.style.overflow="hidden";c.style.display="none";e=document.createElementNS("http://www.w3.org/1999/xhtml","defs");c.appendChild(e);for(f=0;f<d.length;f++)e.appendChild(d[f]);a.appendChild(c)}return a})}
function P(a,b,d){return t(function*(){return d||!b.filter||b.filter(a)?Promise.resolve(a).then(c=>ca(c,b)).then(c=>da(a,c,b)).then(c=>{E(c,Element)&&(ea(a,c,b),G(a,c,":before",b),G(a,c,":after",b),E(a,HTMLTextAreaElement)&&(c.textContent=a.value),E(a,HTMLInputElement)&&c.setAttribute("value",a.value),fa(a,c));return c}).then(c=>ha(c,b)):null})};const Q=/url\((['"]?)([^'"]+?)\1\)/g,ia=/url\([^)]+\)\s*format\((["']?)([^"']+)\1\)/g,ja=/src:\s*(?:url\([^)]+\)\s*format\([^)]+\)[,;]\s*)+/g;function ka(a){const b=[];a.replace(Q,(d,c,e)=>{b.push(e);return d});return b.filter(d=>!H(d))}
function la(a,b,d,c){return t(function*(){try{const e=d?(new URL(b,d||void 0)).toString():b;let f;f=yield L(e,M[N(b).toLowerCase()]||"",c);return a.replace(new RegExp(`(url\\(['"]?)(${b.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")})(['"]?\\))`,"g"),`$1${f}$3`)}catch(e){}return a})}function ma(a,{I:b}){return b?a.replace(ja,d=>{for(;;){const [c,,e]=ia.exec(d)||[],f=c,g=e;if(!g)return"";if(g===b)return`src: ${f};`}}):a}
function R(a,b,d){return t(function*(){if(a.search(Q)===-1)return a;const c=ma(a,d);return ka(c).reduce((e,f)=>e.then(g=>la(g,f,b,d)),Promise.resolve(c))})};function S(a,b,d){return t(function*(){var c;const e=(c=b.style)==null?void 0:c.getPropertyValue(a);return e?(c=yield R(e,null,d),b.style.setProperty(a,c,b.style.getPropertyPriority(a)),!0):!1})}function na(a,b){return t(function*(){(yield S("background",a,b))||(yield S("background-image",a,b));(yield S("mask",a,b))||(yield S("-webkit-mask",a,b))||(yield S("mask-image",a,b))||(yield S("-webkit-mask-image",a,b))})}
function oa(a,b){return t(function*(){const d=E(a,HTMLImageElement);if(d&&!H(a.src)||E(a,SVGImageElement)&&!H(a.href.baseVal)){var c=d?a.src:a.href.baseVal,e=yield L(c,M[N(c).toLowerCase()]||"",b);yield new Promise((f,g)=>{a.onload=f;a.onerror=b.m?(...k)=>{try{f(b.m(...k))}catch(m){g(m)}}:g;a.decode&&(a.decode=f);a.loading==="lazy"&&(a.loading="eager");d?(a.srcset="",a.src=e):a.href.baseVal=e})}})}
function pa(a,b){return t(function*(){const d=w(a.childNodes).map(c=>T(c,b));yield Promise.all(d).then(()=>a)})}function T(a,b){return t(function*(){E(a,Element)&&(yield na(a,b),yield oa(a,b),yield pa(a,b))})};const U={};function V(a){return t(function*(){var b=U[a];if(b!=null)return b;b=yield(yield fetch(a)).text();b={url:a,cssText:b};return U[a]=b})}function W(a,b){return t(function*(){let d=a.cssText;const c=/url\(["']?([^"')]+)["']?\)/g,e=(d.match(/url\([^)]+\)/g)||[]).map(f=>t(function*(){let g=f.replace(c,"$1");g.startsWith("https://")||(g=(new URL(g,a.url)).href);return I(g,b.i,({result:k})=>{d=d.replace(f,`url(${k})`);return[f,k]})}));return Promise.all(e).then(()=>d)})}
function X(a){if(a==null)return[];const b=[];a=a.replace(/(\/\*[\s\S]*?\*\/)/gi,"");for(var d=RegExp("((@.*?keyframes [\\s\\S]*?){([\\s\\S]*?}\\s*?)})","gi");;){var c=d.exec(a);if(c===null)break;b.push(c[0])}a=a.replace(d,"");d=/@import[\s\S]*?url\([^)]*\)[\s\S]*?;/gi;for(c=RegExp("((\\s*?(?:\\/\\*[\\s\\S]*?\\*\\/)?\\s*?@media[\\s\\S]*?){([\\s\\S]*?)}\\s*?})|(([\\s\\S]*?){([\\s\\S]*?)})","gi");;){let e=d.exec(a);if(e===null)if(e=c.exec(a),e===null)break;else d.lastIndex=c.lastIndex;else c.lastIndex=
d.lastIndex;b.push(e[0])}return b}
function qa(a,b){return t(function*(){const d=[],c=[];a.forEach(e=>{if("cssRules"in e)try{w(e.cssRules||[]).forEach((f,g)=>{if(f.type===CSSRule.IMPORT_RULE){let k=g+1;f=V(f.href).then(m=>W(m,b)).then(m=>X(m).forEach(q=>{try{e.insertRule(q,q.startsWith("@import")?k+=1:e.cssRules.length)}catch(Da){}})).catch(()=>{});c.push(f)}})}catch(f){const g=a.find(k=>k.href==null)||document.styleSheets[0];e.href!=null&&c.push(V(e.href).then(k=>W(k,b)).then(k=>X(k).forEach(m=>{g.insertRule(m,g.cssRules.length)})).catch(()=>
{}))}});return Promise.all(c).then(()=>{a.forEach(e=>{if("cssRules"in e)try{w(e.cssRules||[]).forEach(f=>{d.push(f)})}catch(f){}});return d})})}function ra(a){return a.filter(b=>b.type===CSSRule.FONT_FACE_RULE).filter(b=>b.style.getPropertyValue("src").search(Q)!==-1)}function sa(a,b){return t(function*(){if(a.ownerDocument==null)throw Error("Provided element is not within a Document");var d=w(a.ownerDocument.styleSheets);d=yield qa(d,b);return ra(d)})}
function ta(a){function b(c){(c.style.fontFamily||getComputedStyle(c).fontFamily).split(",").forEach(e=>{d.add(e.trim().replace(/["']/g,""))});Array.from(c.children).forEach(e=>{e instanceof HTMLElement&&b(e)})}const d=new Set;b(a);return d}function ua(a,b){return t(function*(){const d=yield sa(a,b),c=ta(a);return(yield Promise.all(d.filter(e=>c.has(e.style.fontFamily.trim().replace(/["']/g,""))).map(e=>R(e.cssText,e.parentStyleSheet?e.parentStyleSheet.href:null,b)))).join("\n")})}
function va(a,b){return t(function*(){const d=b.j!=null?b.j:b.K?null:yield ua(a,b);if(d){const c=document.createElement("style");c.appendChild(document.createTextNode(d));a.firstChild?a.insertBefore(c,a.firstChild):a.appendChild(c)}})};function wa(a,b={}){return t(function*(){const {width:d,height:c}=A(a,b),e=yield P(a,b,!0);yield va(e,b);yield T(e,b);u(e,b);return yield D(e,d,c)})}
function xa(a,b={}){return t(function*(){const {width:d,height:c}=A(a,b);var e=yield wa(a,b);e=yield B(e);const f=document.createElement("canvas"),g=f.getContext("2d"),k=b.G||window.devicePixelRatio||1,m=b.h||d,q=b.g||c;f.width=m*k;f.height=q*k;!b.J&&(f.width>16384||f.height>16384)&&(f.width>16384&&f.height>16384?f.width>f.height?(f.height*=16384/f.width,f.width=16384):(f.width*=16384/f.height,f.height=16384):f.width>16384?(f.height*=16384/f.width,f.width=16384):(f.width*=16384/f.height,f.height=
16384));f.style.width=`${m}`;f.style.height=`${q}`;b.backgroundColor&&(g.fillStyle=b.backgroundColor,g.fillRect(0,0,f.width,f.height));g.drawImage(e,0,0,f.width,f.height);return f})}function ya(a,b={}){return t(function*(){return(yield xa(a,b)).toDataURL()})};const za=["gemini.google.com","corp.google.com","proxy.googlers.com"];function Y(){return document.body.querySelectorAll('[class*="animate"]').length>0}function Z(a){return t(function*(){try{return yield ya(a,{h:a.offsetWidth,g:a.offsetHeight})}catch(d){var b=a.offsetHeight;const c=document.createElement("canvas");c.width=a.offsetWidth;c.height=b;return c.toDataURL("image/png")}})}
function Aa(){return t(function*(){const a=document.body.offsetWidth,b=document.body.offsetHeight,d=document.body.cloneNode(!0);d.querySelectorAll('[class*="animate"]').forEach(c=>{c.classList.remove(...Array.from(c.classList).filter(e=>e.startsWith("animate")))});d.style.width=`${a}px`;d.style.height=`${b}px`;return d})}
function Ba(a){return t(function*(){let b=document.body;if(Y()){var d=yield Aa();b=d;document.body.appendChild(d)}d=yield Z(b);Y()&&document.body.removeChild(b);window.parent.postMessage({type:"SEND_SCREENSHOT",image:d,topOffset:document.documentElement.scrollTop},a.origin)})}function Ca(a){return t(function*(){const b={type:"SEND_SCREENSHOT_FOR_DATA_VISUALIZATION",image:yield Z(document.body),topOffset:0};window.parent.postMessage(b,a.origin)})}
window.addEventListener("message",a=>t(function*(){if(za.some(d=>a.origin.includes(d))){var b=a.data;b&&(b.type==="MAKE_SCREENSHOT"&&(yield Ba(a)),b.type==="MAKE_SCREENSHOT_FOR_DATA_VISUALIZATION"&&(yield Ca(a)))}}));
</script><script>(function() {
  // Ensure this script is executed only once
  if (window.firebaseAuthBridgeScriptLoaded) {
    return;
  }
  window.firebaseAuthBridgeScriptLoaded = true;

  let nextTokenPromiseId = 0;

  // Stores { resolve, reject } for ongoing token requests
  const pendingTokenPromises = {};

  // Listen for messages from the Host Application
  window.addEventListener('message', function(event) {

    const messageData = event.data;

  if (messageData && messageData.type === 'RESOLVE_NEW_FIREBASE_TOKEN') {
      const { success, token, error, promiseId } = messageData ?? {};
      if (pendingTokenPromises[promiseId]) {
        if (success) {
          pendingTokenPromises[promiseId].resolve(token);
        } else {
          pendingTokenPromises[promiseId].reject(new Error(error || 'Token refresh failed from host.'));
        }
        delete pendingTokenPromises[promiseId];
      }
    }
  });

  // Expose a function for the Generated App to request a new Firebase token
  window.requestNewFirebaseToken = function() {
    const currentPromiseId = nextTokenPromiseId++;
    const promise = new Promise((resolve, reject) => {
      pendingTokenPromises[currentPromiseId] = { resolve, reject };
    });
    if (window.parent && window.parent !== window) {
      window.parent.postMessage({
        type: 'REQUEST_NEW_FIREBASE_TOKEN',
        promiseId: currentPromiseId
      }, '*');
    } else {
      pendingTokenPromises[currentPromiseId].reject(new Error('No parent window to request token from.'));
      delete pendingTokenPromises[currentPromiseId];
    }
    return promise;
  };
})();</script><script>
let realOriginalGetUserMedia = null;
if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
  realOriginalGetUserMedia = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
}

(function() {
  if (navigator.mediaDevices && navigator.mediaDevices.__proto__) {
    try {
      Object.defineProperty(navigator.mediaDevices.__proto__, 'getUserMedia', {
        get: function() {
          return undefined; // Or throw an error
        },
        configurable: false
      });
    } catch (error) {
      console.error("Error defining prototype getter:", error);
    }
  }
})();

(function() {
  const pendingMediaResolvers = {};
  let nextMediaPromiseId = 0;

  function requestMediaPermissions(constraints) {
    const mediaPromiseId = nextMediaPromiseId++;
    const promise = new Promise((resolve, reject) => {
      pendingMediaResolvers[mediaPromiseId] = (granted) => {
        delete pendingMediaResolvers[mediaPromiseId];
        resolve(granted);
      };
    });

    window.parent.postMessage({
      type: 'requestMediaPermission',
      constraints: constraints,
      promiseId: mediaPromiseId,
    }, '*');

    return promise;
  }

  let originalGetUserMedia = realOriginalGetUserMedia;

  function interceptGetUserMedia() {
    if (navigator.mediaDevices) {
      Object.defineProperty(navigator.mediaDevices, 'getUserMedia', {
        value: function(constraints) {
          return requestMediaPermissions(constraints).then((granted) => {
            if (granted) {
              if (originalGetUserMedia) {
                return originalGetUserMedia(constraints);
              } else {
                throw new Error("Original getUserMedia not available.");
              }
            } else {
              throw new DOMException('Permission denied', 'NotAllowedError');
            }
          });
        },
        writable: false,
        configurable: false
      });
    }
  }

  interceptGetUserMedia();

  const observer = new MutationObserver(function(mutationsList, observer) {
    for (const mutation of mutationsList) {
      if (mutation.type === 'reconfigured' && mutation.name === 'getUserMedia' && mutation.object === navigator.mediaDevices) {
        interceptGetUserMedia();
      } else if (mutation.type === 'attributes' && mutation.attributeName === 'getUserMedia' && mutation.target === navigator.mediaDevices) {
        interceptGetUserMedia();
      } else if (mutation.type === 'childList' && mutation.addedNodes) {
        mutation.addedNodes.forEach(node => {
          if (node === navigator.mediaDevices) {
            interceptGetUserMedia();
          }
        });
      }
    }
  });

  function interceptSpeechRecognition() {
    if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
      return;
    }

    const OriginalSpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    const SpeechRecognitionWrapper = function(...args) {
      const recognizer = new OriginalSpeechRecognition(...args);
      const originalStart = recognizer.start.bind(recognizer);

      recognizer.start = function() {
        requestMediaPermissions({ audio: true }).then(granted => {
          if (granted) {
            originalStart();
          } else {
            const errorEvent = new SpeechRecognitionErrorEvent('error');
            errorEvent.error = 'not-allowed'; // This is the standard error for permission denial.
            recognizer.dispatchEvent(errorEvent);
          }
        });
      };

      return recognizer;
    };

    SpeechRecognitionWrapper.prototype = OriginalSpeechRecognition.prototype;
    SpeechRecognitionWrapper.prototype.constructor = SpeechRecognitionWrapper;

    if (window.SpeechRecognition) {
      window.SpeechRecognition = SpeechRecognitionWrapper;
    }
    if (window.webkitSpeechRecognition) {
      window.webkitSpeechRecognition = SpeechRecognitionWrapper;
    }
  }

  interceptSpeechRecognition();

  window.addEventListener('message', function(event) {
    if (event.data) {
      if (event.data.type === 'resolveMediaPermission') {
        const { promiseId, granted } = event.data;
        if (pendingMediaResolvers[promiseId]) {
          pendingMediaResolvers[promiseId](granted);
        }
      }
    }
  });

})();</script><script>((function(modelInformation) {
  const originalFetch = window.fetch;
  // TODO: b/421908508 - Move these out of the script and match all generative AI model calls.
  let googleLlmBaseApiUrls = [
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.textModelName + ':streamGenerateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.textModelName + ':generateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageModelName + ':predict',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageModelName + ':predictLongRunning',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageEditModelName + ':generateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageTransformModelName + ':generateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.videoModelName + ':predict',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.videoModelName + ':predictLongRunning',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.ttsModelName + ':generateContent',
  ];
  modelInformation.deprecatedTextModelNames.forEach((modelName) => {
    googleLlmBaseApiUrls.push(
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':streamGenerateContent',
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':generateContent',
    );
  });
  modelInformation.deprecatedImageModelNames.forEach((modelName) => {
    googleLlmBaseApiUrls.push(
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':predict',
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':predictLongRunning',
    );
  });

  const pendingFetchResolvers = {};
  let nextPromiseId = 0;

  function handleStringInput(input, optionsArgument) {
    const actualUrl = input;
    const fetchCallArgs = [actualUrl, optionsArgument];
    const effectiveOptions = optionsArgument || {};
    const bodyForApiKeyCheck = effectiveOptions.body;
    const bodyForPostMessage = effectiveOptions.body;
    return { actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage };
  }

  function handleRequestInput(input, optionsArgument) {
    const actualUrl = input.url;
    const fetchCallArgs = [input, optionsArgument];
    const effectiveOptions = { method: input.method, headers: new Headers(input.headers) };
    let bodyForApiKeyCheck;
    let bodyForPostMessage;

    if (optionsArgument) {
      if (optionsArgument.method) effectiveOptions.method = optionsArgument.method;
      if (optionsArgument.headers) effectiveOptions.headers = new Headers(optionsArgument.headers);
      if ('body' in optionsArgument) {
        bodyForApiKeyCheck = optionsArgument.body;
        bodyForPostMessage = optionsArgument.body;
      } else {
        bodyForApiKeyCheck = undefined;
        bodyForPostMessage = input.body;
      }
    } else {
      bodyForApiKeyCheck = undefined;
      bodyForPostMessage = input.body;
    }
    return { actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage };
  }

  window.fetch = function(input, optionsArgument) {
    let actualUrl;
    let fetchCallArgs;
    let effectiveOptions = {};
    let bodyForApiKeyCheck;
    let bodyForPostMessage;

    if (typeof input === 'string') {
      ({actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage} = handleStringInput(input, optionsArgument));
    } else if (input instanceof Request) {
      ({actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage} = handleRequestInput(input, optionsArgument));
    } else {
      return originalFetch.apply(window, [input, optionsArgument]);
    }

    effectiveOptions.method = effectiveOptions.method || 'GET';
    if (!effectiveOptions.headers) {
      effectiveOptions.headers = new Headers();
    }


    if (typeof actualUrl === 'string' && googleLlmBaseApiUrls.some((url) => actualUrl.startsWith(url))) {
      let apiKeyIsNull = true;

      const regex = new RegExp("models/([^:]+)");
      const modelNameMatch = actualUrl.match(regex);
      const modelName = modelNameMatch ? modelNameMatch[1] : 'unspecified';


      try {
        const urlObject = new URL(actualUrl);  // Use URL object for robust parsing
        const apiKeyParam = urlObject.searchParams.get('key');
        if (apiKeyParam) {
          apiKeyIsNull = false;
        }
      } catch (e) {
        // Continue checks even if URL parsing fails
      }

      if (apiKeyIsNull && effectiveOptions.headers) {
        const h = new Headers(effectiveOptions.headers);
        const apiKeyHeaderValue = h.get('X-API-Key') || h.get('x-api-key');
        if (apiKeyHeaderValue) {
          apiKeyIsNull = false;
          return originalFetch.apply(window, fetchCallArgs);
        }
      }

      if (apiKeyIsNull && effectiveOptions.method && ['POST', 'PUT', 'PATCH'].includes(effectiveOptions.method.toUpperCase()) && typeof bodyForApiKeyCheck === 'string') {
        try {
          const bodyData = JSON.parse(bodyForApiKeyCheck);
          if (bodyData && bodyData.apiKey) {
            apiKeyIsNull = false;
            return originalFetch.apply(window, fetchCallArgs);
          }
        } catch (e) {
          // Ignore JSON parsing errors
        }
      }

      if(apiKeyIsNull) {
        const promiseId = nextPromiseId++;
        const promise = new Promise((resolve) => {
          pendingFetchResolvers[promiseId] = (resolvedResponse) => {
            delete pendingFetchResolvers[promiseId];
            resolve(resolvedResponse);
          };
        });

        let serializedBodyForPostMessage;
        if (typeof bodyForPostMessage === 'string' || bodyForPostMessage == null) {
            serializedBodyForPostMessage = bodyForPostMessage;
        } else if (bodyForPostMessage instanceof ReadableStream) {
            serializedBodyForPostMessage = null;
        } else {
            try {
                serializedBodyForPostMessage = JSON.stringify(bodyForPostMessage);
            } catch (e) {
                serializedBodyForPostMessage = null;
            }
        }

        const messageOptions = {
            method: effectiveOptions.method,
            headers: Object.fromEntries(new Headers(effectiveOptions.headers).entries()),
            body: serializedBodyForPostMessage
        };

        window.parent.postMessage({
          type: 'requestFetch',
          url: actualUrl,
          modelName: modelName,
          options: messageOptions,
          promiseId: promiseId,
        }, '*');

        return promise;
      }
      return originalFetch.apply(window, fetchCallArgs);
    }
    return originalFetch.apply(window, fetchCallArgs);
  };

  window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'resolveFetch') {
      const { promiseId, response } = event.data;
      if (pendingFetchResolvers[promiseId]) {
        try {
          const reconstructedResponse = new Response(response.body, {
            status: response.status,
            statusText: response.statusText,
            headers: new Headers(response.headers),
          });
          pendingFetchResolvers[promiseId](reconstructedResponse);
        } catch (error) {
          pendingFetchResolvers[promiseId](new Response(null, { status: 500, statusText: "Interceptor Response Reconstruction Error" }));
        }
      }
    }
  });

}))({"textModelName":"gemini-2.5-flash-preview-09-2025","imageModelName":"imagen-4.0-generate-001","imageEditModelName":"gemini-2.5-flash-image-preview","imageTransformModelName":"gemini-3-pro-image-preview-11-2025","videoModelName":"veo-2.0-generate-001","ttsModelName":"gemini-2.5-flash-preview-tts","deprecatedTextModelNames":["gemini-2.0-flash","gemini-2.5-flash-preview-04-17","gemini-2.5-flash-preview-05-20"],"deprecatedImageModelNames":["imagen-3.0-generate-001","imagen-3.0-generate-002"]})</script><script>(function() {
  const originalConsoleLog = console.log;
  const originalConsoleError = console.error;

    /**
   * Normalizes an error event or a promise rejection reason into a structured error object.
   * @param {*} errorEventOrReason The error object or reason.
   * @return {object} Structured error data { message, name, stack }.
   */
  function getErrorObject(errorEventOrReason) {
    if (errorEventOrReason instanceof Error) {
      return {
        message: errorEventOrReason.message,
        name: errorEventOrReason.name,
        stack: errorEventOrReason.stack,
      };
    }
    // Fallback for non-Error objects.
    try {
      return {
        message: JSON.stringify(errorEventOrReason),
        name: 'UnknownErrorType',
        stack: null,
      };
    } catch (e) {
      return {
        message: String(errorEventOrReason),
        name: 'UnknownErrorTypeNonStringifiable',
        stack: null,
      };
    }
  }

  /**
   * Converts an array of arguments (from log/error) into a single string.
   * Handles Error objects specially to include their message and stack.
   * @param {Array<*>} args - Arguments passed to console methods.
   * @return {string} A string representation of the arguments.
   */
  function stringifyArgs(args) {
    return args
      .map((arg) => {
        if (arg instanceof Error) {
          const {message, stack} = arg;
          return `Error: ${message}${stack ? ('\nStack: ' + stack) : ''}`;
        }
        if (typeof arg === 'object' && arg !== null) {
          try {
            return JSON.stringify(arg);
          } catch (error) {
            return '[Circular Object]';
          }
        } else {
          return String(arg);
        }
      })
      .join(' ');
  }

  console.log = function(...args) {
    const logString = stringifyArgs(args);
    window.parent.postMessage({ type: 'log', message: logString }, '*');
    originalConsoleLog.apply(console, args);
  };

  console.error = function(...args) {
    let errorData;
    if (args.length > 0 && args[0] instanceof Error) {
      const err = args[0];
      // If the first arg is an Error, capture its details.
      errorData = {
        type: 'error',
        source: 'CONSOLE_ERROR',
        ...getErrorObject(err),
        rawArgsString: stringifyArgs(args.slice(1)),
        timestamp: new Date().toISOString(),
      };
    } else {
      // If not an Error object, treat all args as a general error message.
      errorData = {
        type: 'error',
        source: 'CONSOLE_ERROR',
        message: stringifyArgs(args),
        name: 'ConsoleLoggedError',
        stack: null,
        timestamp: new Date().toISOString(),
      };
    }
    window.parent.postMessage(errorData, '*');
    originalConsoleError.apply(console, args);
  };

  // Listen for global unhandled synchronous errors.
  window.addEventListener('error', function(event) {
    const errorDetails = event.error ? getErrorObject(event.error) : {
      message: event.message,
      name: 'GlobalError',
      stack: null,
      filename: event.filename,
      lineno: event.lineno,
      colno: event.colno,
    };

    window.parent.postMessage({
      type: 'error',
      source: 'global',
      ...errorDetails,
      message: errorDetails.message || event.message,
      timestamp: new Date().toISOString(),
    }, '*');
  });

  // Listen for unhandled promise rejections (asynchronous errors).
  window.addEventListener('unhandledrejection', function(event) {
    const errorDetails = getErrorObject(event.reason);

    window.parent.postMessage({
      type: 'error',
      source: 'unhandledrejection',
      ...errorDetails,
      message: errorDetails.message || 'Unhandled Promise Rejection',
      timestamp: new Date().toISOString(),
    }, '*');
  });

})();</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Lens | ChatService Reranking Walkthrough</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&amp;family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Prism.js for Highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js" crossorigin="anonymous"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Fira Code', 'monospace'],
                    },
                    colors: {
                        slate: { 50: '#f4f7fb' },
                        indigo: { 600: '#6366f1' },
                        gh: {
                            bg: '#0d1117',
                            darker: '#010409',
                            border: '#30363d',
                            keyword: '#ff7b72',
                            string: '#a5d6ff',
                            func: '#d2a8ff'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Prism GitHub Dark Theme */
        code[class*="language-"], pre[class*="language-"] {
            color: #c9d1d9;
            background: none;
            font-family: 'Fira Code', monospace;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .token.keyword { color: #ff7b72; }
        .token.string { color: #a5d6ff; }
        .token.function { color: #d2a8ff; }
        .token.comment { color: #8b949e; }
        .token.class-name { color: #ffa657; }
        .token.operator { color: #79c0ff; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0d1117; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #484f58; }

        .explanation-panel { scroll-behavior: smooth; }
        .code-panel { scroll-behavior: smooth; transition: all 0.3s ease; }

        /* Lens Effect */
        .code-line {
            display: block;
            padding: 0 1.5rem;
            transition: opacity 0.3s ease, background 0.3s ease;
            border-left: 3px solid transparent;
        }
        .code-line.dimmed { opacity: 0.25; }
        .code-line.active { 
            opacity: 1; 
            background: rgba(99, 102, 241, 0.1); 
            border-left-color: #6366f1; 
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .traffic-light { width: 12px; height: 12px; border-radius: 50%; }
    </style>
<style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:Inter, sans-serif;font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:Fira Code, monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.inset-0{inset:0px}.inset-x-0{left:0px;right:0px}.top-0{top:0px}.bottom-0{bottom:0px}.z-50{z-index:50}.\!m-0{margin:0px !important}.mx-auto{margin-left:auto;margin-right:auto}.mb-2{margin-bottom:0.5rem}.mb-3{margin-bottom:0.75rem}.flex{display:flex}.hidden{display:none}.h-1{height:0.25rem}.h-16{height:4rem}.h-5{height:1.25rem}.h-full{height:100%}.h-screen{height:100vh}.h-8{height:2rem}.max-h-\[60vh\]{max-height:60vh}.w-0{width:0px}.w-5{width:1.25rem}.w-\[40\%\]{width:40%}.w-\[60\%\]{width:60%}.w-full{width:100%}.w-8{width:2rem}.max-w-3xl{max-width:48rem}.max-w-xl{max-width:36rem}.flex-1{flex:1 1 0%}.origin-left{transform-origin:left}.scale-x-0{--tw-scale-x:0;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.transform{transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.cursor-pointer{cursor:pointer}.flex-col{flex-direction:column}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-2{gap:0.5rem}.gap-3{gap:0.75rem}.gap-4{gap:1rem}.space-y-8 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(2rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(2rem * var(--tw-space-y-reverse))}.overflow-auto{overflow:auto}.overflow-hidden{overflow:hidden}.overflow-y-auto{overflow-y:auto}.rounded-2xl{border-radius:1rem}.rounded-full{border-radius:9999px}.rounded-xl{border-radius:0.75rem}.rounded-3xl{border-radius:1.5rem}.rounded-b-3xl{border-bottom-right-radius:1.5rem;border-bottom-left-radius:1.5rem}.border{border-width:1px}.border-2{border-width:2px}.border-b{border-bottom-width:1px}.border-r{border-right-width:1px}.border-gh-border{--tw-border-opacity:1;border-color:rgb(48 54 61 / var(--tw-border-opacity, 1))}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235 / var(--tw-border-opacity, 1))}.border-indigo-600{--tw-border-opacity:1;border-color:rgb(99 102 241 / var(--tw-border-opacity, 1))}.border-transparent{border-color:transparent}.bg-\[\#161b22\]{--tw-bg-opacity:1;background-color:rgb(22 27 34 / var(--tw-bg-opacity, 1))}.bg-\[\#27c93f\]{--tw-bg-opacity:1;background-color:rgb(39 201 63 / var(--tw-bg-opacity, 1))}.bg-\[\#ff5f56\]{--tw-bg-opacity:1;background-color:rgb(255 95 86 / var(--tw-bg-opacity, 1))}.bg-\[\#ffbd2e\]{--tw-bg-opacity:1;background-color:rgb(255 189 46 / var(--tw-bg-opacity, 1))}.bg-gh-bg{--tw-bg-opacity:1;background-color:rgb(13 17 23 / var(--tw-bg-opacity, 1))}.bg-gh-darker{--tw-bg-opacity:1;background-color:rgb(1 4 9 / var(--tw-bg-opacity, 1))}.bg-gray-200{--tw-bg-opacity:1;background-color:rgb(229 231 235 / var(--tw-bg-opacity, 1))}.bg-indigo-600{--tw-bg-opacity:1;background-color:rgb(99 102 241 / var(--tw-bg-opacity, 1))}.bg-slate-50{--tw-bg-opacity:1;background-color:rgb(244 247 251 / var(--tw-bg-opacity, 1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.bg-slate-100{--tw-bg-opacity:1;background-color:rgb(241 245 249 / var(--tw-bg-opacity, 1))}.\!p-0{padding:0px !important}.p-2{padding:0.5rem}.p-6{padding:1.5rem}.p-8{padding:2rem}.px-2{padding-left:0.5rem;padding-right:0.5rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.px-4{padding-left:1rem;padding-right:1rem}.px-5{padding-left:1.25rem;padding-right:1.25rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.px-8{padding-left:2rem;padding-right:2rem}.py-1{padding-top:0.25rem;padding-bottom:0.25rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.pb-32{padding-bottom:8rem}.pt-16{padding-top:4rem}.pt-4{padding-top:1rem}.font-mono{font-family:Fira Code, monospace}.font-sans{font-family:Inter, sans-serif}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xs{font-size:0.75rem;line-height:1rem}.text-\[10px\]{font-size:10px}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-semibold{font-weight:600}.uppercase{text-transform:uppercase}.italic{font-style:italic}.leading-relaxed{line-height:1.625}.tracking-tight{letter-spacing:-0.025em}.tracking-widest{letter-spacing:0.1em}.text-indigo-600{--tw-text-opacity:1;color:rgb(99 102 241 / var(--tw-text-opacity, 1))}.text-slate-400{--tw-text-opacity:1;color:rgb(148 163 184 / var(--tw-text-opacity, 1))}.text-slate-500{--tw-text-opacity:1;color:rgb(100 116 139 / var(--tw-text-opacity, 1))}.text-slate-900{--tw-text-opacity:1;color:rgb(15 23 42 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.text-slate-800{--tw-text-opacity:1;color:rgb(30 41 59 / var(--tw-text-opacity, 1))}.opacity-50{opacity:0.5}.shadow-2xl{--tw-shadow:0 25px 50px -12px rgb(0 0 0 / 0.25);--tw-shadow-colored:0 25px 50px -12px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-indigo-200{--tw-shadow-color:#c7d2fe;--tw-shadow:var(--tw-shadow-colored)}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-transform{transition-property:transform;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-colors{transition-property:color, background-color, border-color, fill, stroke, -webkit-text-decoration-color;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, -webkit-text-decoration-color;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.duration-300{transition-duration:300ms}.duration-500{transition-duration:500ms}.hover\:scale-\[1\.01\]:hover{--tw-scale-x:1.01;--tw-scale-y:1.01;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.hover\:border-indigo-100:hover{--tw-border-opacity:1;border-color:rgb(224 231 255 / var(--tw-border-opacity, 1))}.hover\:bg-indigo-700:hover{--tw-bg-opacity:1;background-color:rgb(67 56 202 / var(--tw-bg-opacity, 1))}.hover\:shadow-md:hover{--tw-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color), 0 2px 4px -2px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.group.active-card .group-\[\.active-card\]\:scale-x-100{--tw-scale-x:1;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.group.active-card .group-\[\.active-card\]\:bg-indigo-600{--tw-bg-opacity:1;background-color:rgb(99 102 241 / var(--tw-bg-opacity, 1))}.group.active-card .group-\[\.active-card\]\:text-indigo-600{--tw-text-opacity:1;color:rgb(99 102 241 / var(--tw-text-opacity, 1))}.group.active-card .group-\[\.active-card\]\:text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}@media (min-width: 768px){.md\:flex{display:flex}}</style></head>
<body class="bg-slate-50 font-sans text-slate-900 overflow-hidden h-screen">

    <!-- Header -->
    <header class="glass-header fixed top-0 w-full z-50 h-16 flex flex-col justify-between">
        <div class="flex items-center justify-between px-8 h-full">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-xl">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                    </svg>
                </div>
                <div>
                    <h1 class="font-bold text-lg tracking-tight">Code Lens</h1>
                    <p class="text-xs text-slate-500 font-medium uppercase tracking-widest">ChatService.py Walkthrough</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="hidden md:flex items-center gap-2 px-3 py-1 bg-white rounded-full border shadow-sm">
                    <span id="progress-text" class="text-xs font-bold text-indigo-600">17%</span>
                    <span class="text-xs text-slate-400">Complete</span>
                </div>
                <button id="view-toggle" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-xl text-sm font-semibold transition-all shadow-lg shadow-indigo-200">
                    Switch to Full Mode
                </button>
            </div>
        </div>
        <div class="w-full bg-gray-200 h-1">
            <div id="progress-bar" class="h-full bg-indigo-600 transition-all duration-300 w-0" style="width: 17%;"></div>
        </div>
    </header>

    <!-- Main Container -->
    <main class="flex h-screen pt-16">
        
        <!-- Left Panel: Explanation -->
        <section id="explanation-panel" class="w-[40%] overflow-y-auto p-8 explanation-panel border-r border-gray-200">
            <div class="max-w-xl mx-auto space-y-8 pb-32">
                <div id="cards-container">
                <div id="card-0" onclick="activateStep(1)" class="card group relative bg-white p-6 rounded-3xl shadow-sm border-2 transition-all cursor-pointer hover:shadow-md hover:border-indigo-100 active-card border-indigo-600">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="flex items-center justify-center w-8 h-8 rounded-full bg-slate-100 text-slate-500 font-bold text-xs group-[.active-card]:bg-indigo-600 group-[.active-card]:text-white transition-colors">
                            1
                        </span>
                        <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400 group-[.active-card]:text-indigo-600">Candidate Pre-Filtering</span>
                    </div>
                    <h3 class="font-bold text-slate-800 text-lg mb-2 group-[.active-card]:text-indigo-600">Metadata Filters as Pre-Ranking Constraints</h3>
                    <p class="text-sm text-slate-500 leading-relaxed">This helper converts request-level metadata into LlamaIndex MetadataFilter objects. While not a re-ranker itself, metadata filtering directly constrains the candidate pool before any re-ranking can occur.</p>
                    <div class="absolute inset-x-0 bottom-0 h-1 rounded-b-3xl bg-indigo-600 scale-x-0 group-[.active-card]:scale-x-100 transition-transform origin-left"></div>
                </div>
            
                <div id="card-1" onclick="activateStep(2)" class="card group relative bg-white p-6 rounded-3xl shadow-sm border-2 border-transparent transition-all cursor-pointer hover:shadow-md hover:border-indigo-100">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="flex items-center justify-center w-8 h-8 rounded-full bg-slate-100 text-slate-500 font-bold text-xs group-[.active-card]:bg-indigo-600 group-[.active-card]:text-white transition-colors">
                            2
                        </span>
                        <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400 group-[.active-card]:text-indigo-600">Re-ranking Strategy Injection</span>
                    </div>
                    <h3 class="font-bold text-slate-800 text-lg mb-2 group-[.active-card]:text-indigo-600">Query Engine Construction with Re-ranking</h3>
                    <p class="text-sm text-slate-500 leading-relaxed">The QueryEngineManager is instantiated with a Cohere API key. The build() call is the critical handoff where the index, metadata filters, and re-ranking strategy are composed into a single query engine.</p>
                    <div class="absolute inset-x-0 bottom-0 h-1 rounded-b-3xl bg-indigo-600 scale-x-0 group-[.active-card]:scale-x-100 transition-transform origin-left"></div>
                </div>
            
                <div id="card-2" onclick="activateStep(3)" class="card group relative bg-white p-6 rounded-3xl shadow-sm border-2 border-transparent transition-all cursor-pointer hover:shadow-md hover:border-indigo-100">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="flex items-center justify-center w-8 h-8 rounded-full bg-slate-100 text-slate-500 font-bold text-xs group-[.active-card]:bg-indigo-600 group-[.active-card]:text-white transition-colors">
                            3
                        </span>
                        <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400 group-[.active-card]:text-indigo-600">Re-ranked Retrieval Path</span>
                    </div>
                    <h3 class="font-bold text-slate-800 text-lg mb-2 group-[.active-card]:text-indigo-600">Standard RAG Query Engine with Re-ranking</h3>
                    <p class="text-sm text-slate-500 leading-relaxed">In the standard RAG chat flow, the query engine is built once. From this point onward, all document retrievals implicitly include re-ranking if configured in the QueryEngineManager.</p>
                    <div class="absolute inset-x-0 bottom-0 h-1 rounded-b-3xl bg-indigo-600 scale-x-0 group-[.active-card]:scale-x-100 transition-transform origin-left"></div>
                </div>
            
                <div id="card-3" onclick="activateStep(4)" class="card group relative bg-white p-6 rounded-3xl shadow-sm border-2 border-transparent transition-all cursor-pointer hover:shadow-md hover:border-indigo-100">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="flex items-center justify-center w-8 h-8 rounded-full bg-slate-100 text-slate-500 font-bold text-xs group-[.active-card]:bg-indigo-600 group-[.active-card]:text-white transition-colors">
                            4
                        </span>
                        <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400 group-[.active-card]:text-indigo-600">Re-ranking Mode Selection</span>
                    </div>
                    <h3 class="font-bold text-slate-800 text-lg mb-2 group-[.active-card]:text-indigo-600">Report Mode Specialized Re-ranking</h3>
                    <p class="text-sm text-slate-500 leading-relaxed">For report generation, the QueryEngineManager is constructed with mode="REPORT", which typically implies a heavier re-ranking configuration (e.g., larger cross-encoders).</p>
                    <div class="absolute inset-x-0 bottom-0 h-1 rounded-b-3xl bg-indigo-600 scale-x-0 group-[.active-card]:scale-x-100 transition-transform origin-left"></div>
                </div>
            
                <div id="card-4" onclick="activateStep(5)" class="card group relative bg-white p-6 rounded-3xl shadow-sm border-2 border-transparent transition-all cursor-pointer hover:shadow-md hover:border-indigo-100">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="flex items-center justify-center w-8 h-8 rounded-full bg-slate-100 text-slate-500 font-bold text-xs group-[.active-card]:bg-indigo-600 group-[.active-card]:text-white transition-colors">
                            5
                        </span>
                        <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400 group-[.active-card]:text-indigo-600">Re-ranked Context Consumption</span>
                    </div>
                    <h3 class="font-bold text-slate-800 text-lg mb-2 group-[.active-card]:text-indigo-600">Propagation of Re-ranked Nodes</h3>
                    <p class="text-sm text-slate-500 leading-relaxed">The Generate object receives the fully constructed query engine, meaning any re-ranking decisions have already been applied by the time generation starts.</p>
                    <div class="absolute inset-x-0 bottom-0 h-1 rounded-b-3xl bg-indigo-600 scale-x-0 group-[.active-card]:scale-x-100 transition-transform origin-left"></div>
                </div>
            
                <div id="card-5" onclick="activateStep(6)" class="card group relative bg-white p-6 rounded-3xl shadow-sm border-2 border-transparent transition-all cursor-pointer hover:shadow-md hover:border-indigo-100">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="flex items-center justify-center w-8 h-8 rounded-full bg-slate-100 text-slate-500 font-bold text-xs group-[.active-card]:bg-indigo-600 group-[.active-card]:text-white transition-colors">
                            6
                        </span>
                        <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400 group-[.active-card]:text-indigo-600">Post-Re-ranking Attribution</span>
                    </div>
                    <h3 class="font-bold text-slate-800 text-lg mb-2 group-[.active-card]:text-indigo-600">Re-ranking Impact on Streaming</h3>
                    <p class="text-sm text-slate-500 leading-relaxed">During streaming, context chunks are emitted to the client. These reflect the ordering and selection imposed by the re-ranking layer inside the query engine.</p>
                    <div class="absolute inset-x-0 bottom-0 h-1 rounded-b-3xl bg-indigo-600 scale-x-0 group-[.active-card]:scale-x-100 transition-transform origin-left"></div>
                </div>
            </div>
            </div>
        </section>

        <!-- Right Panel: Code -->
        <section class="w-[60%] bg-gh-bg relative overflow-hidden flex flex-col">
            
            <!-- Snippet Window (Focused Mode) -->
            <div id="snippet-container" class="flex-1 flex flex-col items-center justify-center p-8 transition-all duration-500">
                <div class="w-full max-w-3xl bg-gh-darker rounded-2xl shadow-2xl border border-gh-border overflow-hidden transform hover:scale-[1.01] transition-transform">
                    <div class="flex items-center justify-between px-4 py-3 bg-[#161b22] border-b border-gh-border">
                        <div class="flex gap-2">
                            <div class="traffic-light bg-[#ff5f56]"></div>
                            <div class="traffic-light bg-[#ffbd2e]"></div>
                            <div class="traffic-light bg-[#27c93f]"></div>
                        </div>
                        <div id="snippet-label" class="text-xs text-slate-400 font-mono italic px-2">Candidate Pre-Filtering (Lines 32-38)</div>
                    </div>
                    <div class="p-6 overflow-auto max-h-[60vh]">
                        <pre class="language-python" tabindex="0"><code id="snippet-code" class="language-python">    <span class="token keyword">def</span> <span class="token function">_prepare_metadata_filters</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> metadata<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>MetadataFilter<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Prepare metadata filters from metadata dict."""</span>
        <span class="token keyword">if</span> metadata <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">"No metadata provided; returning empty filter list."</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># Return an empty list if no metadata is provided</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Preparing metadata filters: </span><span class="token interpolation"><span class="token punctuation">{</span>metadata<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>MetadataFilter<span class="token punctuation">(</span>key<span class="token operator">=</span>key<span class="token punctuation">,</span> value<span class="token operator">=</span>value<span class="token punctuation">)</span> <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> metadata<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre>
                    </div>
                </div>
            </div>

            <!-- Full Code (Lens Mode) -->
            <div id="full-code-container" class="hidden absolute inset-0 flex flex-col">
                <div class="flex items-center px-6 py-3 bg-[#161b22] border-b border-gh-border text-xs text-slate-400 font-mono">
                    <span class="opacity-50">src / services /</span> chat_service.py
                </div>
                <div id="full-code-scroll" class="flex-1 overflow-y-auto pt-4 pb-32 font-mono">
                    <pre class="!m-0 language-python" tabindex="0"><code id="full-code-content" class="!p-0 language-python"><span class="code-line" id="line-1"><span class="token keyword">import</span> logging</span><span class="code-line" id="line-2"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional<span class="token punctuation">,</span> Dict<span class="token punctuation">,</span> Any<span class="token punctuation">,</span> Generator</span><span class="code-line" id="line-3"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime</span><span class="code-line" id="line-4"><span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>responses <span class="token keyword">import</span> StreamingResponse<span class="token punctuation">,</span> JSONResponse</span><span class="code-line" id="line-5"><span class="token keyword">import</span> uuid</span><span class="code-line" id="line-6"><span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>models<span class="token punctuation">.</span>base <span class="token keyword">import</span> ChatMessage<span class="token punctuation">,</span> ChatHistory</span><span class="code-line" id="line-7"><span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>schemas<span class="token punctuation">.</span>api <span class="token keyword">import</span> ChatRequest<span class="token punctuation">,</span> ChatResponse</span><span class="code-line" id="line-8"><span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>schemas<span class="token punctuation">.</span>rag <span class="token keyword">import</span> ChatRAGRequest</span><span class="code-line" id="line-9"><span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>managers<span class="token punctuation">.</span>storage_manager <span class="token keyword">import</span> LocalStorageManager</span><span class="code-line" id="line-10"><span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>managers<span class="token punctuation">.</span>llm_manager <span class="token keyword">import</span> LLMManager</span><span class="code-line" id="line-11"><span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>managers<span class="token punctuation">.</span>query_engine_manager <span class="token keyword">import</span> QueryEngineManager</span><span class="code-line" id="line-12"><span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>managers<span class="token punctuation">.</span>storage_context_manager <span class="token keyword">import</span> StorageContextManager</span><span class="code-line" id="line-13"><span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>managers<span class="token punctuation">.</span>prompt_manager <span class="token keyword">import</span> PromptManager</span><span class="code-line" id="line-14"><span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>generate <span class="token keyword">import</span> Generate</span><span class="code-line" id="line-15"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional<span class="token punctuation">,</span> Dict<span class="token punctuation">,</span> Generator<span class="token punctuation">,</span> List<span class="token punctuation">,</span> Any<span class="token punctuation">,</span> Union<span class="token punctuation">,</span> Tuple<span class="token punctuation">,</span> Callable<span class="token punctuation">,</span> AsyncGenerator</span><span class="code-line" id="line-16"><span class="token keyword">from</span> llama_index<span class="token punctuation">.</span>core<span class="token punctuation">.</span>vector_stores <span class="token keyword">import</span> MetadataFilters<span class="token punctuation">,</span> MetadataFilter</span><span class="code-line" id="line-17"><span class="token keyword">from</span> llama_index<span class="token punctuation">.</span>core <span class="token keyword">import</span> Settings<span class="token punctuation">,</span> PromptHelper</span><span class="code-line" id="line-18"><span class="token keyword">import</span> time</span><span class="code-line" id="line-19"><span class="token keyword">import</span> json</span><span class="code-line" id="line-20"></span><span class="code-line" id="line-21">logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span></span><span class="code-line" id="line-22"></span><span class="code-line" id="line-23"></span><span class="code-line" id="line-24"><span class="token keyword">class</span> <span class="token class-name">ChatService</span><span class="token punctuation">:</span></span><span class="code-line" id="line-25">    <span class="token triple-quoted-string string">"""Service for handling chat operations."""</span></span><span class="code-line" id="line-26">    </span><span class="code-line" id="line-27">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> storage_manager<span class="token punctuation">:</span> LocalStorageManager<span class="token punctuation">,</span> llm_manager<span class="token punctuation">:</span> LLMManager<span class="token punctuation">,</span> settings_manager<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="code-line" id="line-28">        self<span class="token punctuation">.</span>_storage_manager <span class="token operator">=</span> storage_manager</span><span class="code-line" id="line-29">        self<span class="token punctuation">.</span>_llm <span class="token operator">=</span> llm_manager</span><span class="code-line" id="line-30">        self<span class="token punctuation">.</span>_settings <span class="token operator">=</span> settings_manager</span><span class="code-line" id="line-31">    </span><span class="code-line" id="line-32">    <span class="token keyword">def</span> <span class="token function">_prepare_metadata_filters</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> metadata<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>MetadataFilter<span class="token punctuation">]</span><span class="token punctuation">:</span></span><span class="code-line" id="line-33">        <span class="token triple-quoted-string string">"""Prepare metadata filters from metadata dict."""</span></span><span class="code-line" id="line-34">        <span class="token keyword">if</span> metadata <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span><span class="code-line" id="line-35">            logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">"No metadata provided; returning empty filter list."</span><span class="token punctuation">)</span></span><span class="code-line" id="line-36">            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># Return an empty list if no metadata is provided</span></span><span class="code-line" id="line-37">        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Preparing metadata filters: </span><span class="token interpolation"><span class="token punctuation">{</span>metadata<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span><span class="code-line" id="line-38">        <span class="token keyword">return</span> <span class="token punctuation">[</span>MetadataFilter<span class="token punctuation">(</span>key<span class="token operator">=</span>key<span class="token punctuation">,</span> value<span class="token operator">=</span>value<span class="token punctuation">)</span> <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> metadata<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span></span><span class="code-line" id="line-39">        </span><span class="code-line" id="line-40">    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">process_chat</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> ChatRequest<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> ChatResponse<span class="token punctuation">:</span></span><span class="code-line" id="line-41">        <span class="token triple-quoted-string string">"""Process a basic chat request."""</span></span><span class="code-line" id="line-42">        <span class="token keyword">try</span><span class="token punctuation">:</span></span><span class="code-line" id="line-43">            self<span class="token punctuation">.</span>_storage_manager<span class="token punctuation">.</span>load_chat_history<span class="token punctuation">(</span>request<span class="token punctuation">.</span>chat_id<span class="token punctuation">)</span></span><span class="code-line" id="line-44">            response_text <span class="token operator">=</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>_llm<span class="token punctuation">.</span>generate_response<span class="token punctuation">(</span>request<span class="token punctuation">.</span>message<span class="token punctuation">)</span></span><span class="code-line" id="line-45">            self<span class="token punctuation">.</span>_storage_manager<span class="token punctuation">.</span>chat_hist <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>request<span class="token punctuation">.</span>message<span class="token punctuation">}</span></span><span class="token string">\n</span><span class="token interpolation"><span class="token punctuation">{</span>response_text<span class="token punctuation">}</span></span><span class="token string">\n\n"</span></span></span><span class="code-line" id="line-46">            <span class="token keyword">return</span> ChatResponse<span class="token punctuation">(</span></span><span class="code-line" id="line-47">                chat_id<span class="token operator">=</span>request<span class="token punctuation">.</span>chat_id<span class="token punctuation">,</span></span><span class="code-line" id="line-48">                message<span class="token operator">=</span>response_text<span class="token punctuation">,</span></span><span class="code-line" id="line-49">                metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"model"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_llm<span class="token punctuation">.</span>model_name<span class="token punctuation">}</span></span><span class="code-line" id="line-50">            <span class="token punctuation">)</span></span><span class="code-line" id="line-51">        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></span><span class="code-line" id="line-52">            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error processing chat request: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span><span class="code-line" id="line-53">            <span class="token keyword">raise</span></span><span class="code-line" id="line-54"></span><span class="code-line" id="line-55">    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">process_rag_chat</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> ChatRequest<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> StreamingResponse<span class="token punctuation">:</span></span><span class="code-line" id="line-56">        <span class="token triple-quoted-string string">"""Process a RAG-based chat request."""</span></span><span class="code-line" id="line-57">        <span class="token keyword">try</span><span class="token punctuation">:</span></span><span class="code-line" id="line-58">            start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="code-line" id="line-59">            logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Processing RAG chat request for chat_id: </span><span class="token interpolation"><span class="token punctuation">{</span>request<span class="token punctuation">.</span>chat_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span><span class="code-line" id="line-60">            Settings<span class="token punctuation">.</span>_prompt_helper <span class="token operator">=</span> PromptHelper<span class="token punctuation">(</span>context_window<span class="token operator">=</span><span class="token number">20000</span><span class="token punctuation">)</span></span><span class="code-line" id="line-61">            Settings<span class="token punctuation">.</span>llm <span class="token operator">=</span> self<span class="token punctuation">.</span>_llm<span class="token punctuation">.</span>llm_model</span><span class="code-line" id="line-62">            Settings<span class="token punctuation">.</span>embed_model <span class="token operator">=</span> self<span class="token punctuation">.</span>_llm<span class="token punctuation">.</span>embed_model</span><span class="code-line" id="line-63">            self<span class="token punctuation">.</span>_storage_manager<span class="token punctuation">.</span>load_chat_history<span class="token punctuation">(</span>request<span class="token punctuation">.</span>chat_id<span class="token punctuation">)</span></span><span class="code-line" id="line-64">            collection_name<span class="token operator">=</span><span class="token string">"documents"</span></span><span class="code-line" id="line-65">            prompts <span class="token operator">=</span> PromptManager<span class="token punctuation">.</span>load_prompts<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_settings<span class="token punctuation">.</span>get_setting<span class="token punctuation">)</span></span><span class="code-line" id="line-66">            metadata_filters <span class="token operator">=</span> self<span class="token punctuation">.</span>_prepare_metadata_filters<span class="token punctuation">(</span>request<span class="token punctuation">.</span>metadata<span class="token punctuation">)</span></span><span class="code-line" id="line-67">            storage_context_manager <span class="token operator">=</span> StorageContextManager<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_settings<span class="token punctuation">.</span>get_setting<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_settings<span class="token punctuation">.</span>get_secret_value<span class="token punctuation">)</span></span><span class="code-line" id="line-68">            index <span class="token operator">=</span> storage_context_manager<span class="token punctuation">.</span>setup_storage_context<span class="token punctuation">(</span>collection_name<span class="token punctuation">)</span></span><span class="code-line" id="line-69"></span><span class="code-line" id="line-70">            queryenginemanager <span class="token operator">=</span> QueryEngineManager<span class="token punctuation">(</span></span><span class="code-line" id="line-71">                model_manager<span class="token operator">=</span>self<span class="token punctuation">.</span>_llm<span class="token punctuation">,</span></span><span class="code-line" id="line-72">                prompts<span class="token operator">=</span>prompts<span class="token punctuation">,</span></span><span class="code-line" id="line-73">                config<span class="token operator">=</span>self<span class="token punctuation">.</span>_settings<span class="token punctuation">.</span>get_setting<span class="token punctuation">,</span></span><span class="code-line" id="line-74">                cohere_api_key<span class="token operator">=</span>self<span class="token punctuation">.</span>_settings<span class="token punctuation">.</span>get_secret_value<span class="token punctuation">(</span><span class="token string">"COHERE_API_KEY"</span><span class="token punctuation">)</span></span><span class="code-line" id="line-75">            <span class="token punctuation">)</span></span><span class="code-line" id="line-76">            query_engine <span class="token operator">=</span> queryenginemanager<span class="token punctuation">.</span>build<span class="token punctuation">(</span>index<span class="token punctuation">,</span> metadata_filters<span class="token punctuation">)</span></span><span class="code-line" id="line-77"></span><span class="code-line" id="line-78">            generate <span class="token operator">=</span> Generate<span class="token punctuation">(</span></span><span class="code-line" id="line-79">                config<span class="token operator">=</span>self<span class="token punctuation">.</span>_settings<span class="token punctuation">.</span>get_setting<span class="token punctuation">,</span></span><span class="code-line" id="line-80">                secret<span class="token operator">=</span>self<span class="token punctuation">.</span>_settings<span class="token punctuation">.</span>get_secret_value<span class="token punctuation">,</span></span><span class="code-line" id="line-81">                chat_id<span class="token operator">=</span>request<span class="token punctuation">.</span>chat_id<span class="token punctuation">,</span></span><span class="code-line" id="line-82">                query<span class="token operator">=</span>request<span class="token punctuation">.</span>message<span class="token punctuation">,</span></span><span class="code-line" id="line-83">                category_name<span class="token operator">=</span>request<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"category"</span><span class="token punctuation">,</span> <span class="token string">"general"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="code-line" id="line-84">                metadata<span class="token operator">=</span>request<span class="token punctuation">.</span>metadata<span class="token punctuation">,</span></span><span class="code-line" id="line-85">                collection_name<span class="token operator">=</span>collection_name<span class="token punctuation">,</span></span><span class="code-line" id="line-86">                s3_manager<span class="token operator">=</span>self<span class="token punctuation">.</span>_storage_manager<span class="token punctuation">,</span></span><span class="code-line" id="line-87">                storage_manager<span class="token operator">=</span>self<span class="token punctuation">.</span>_storage_manager<span class="token punctuation">,</span></span><span class="code-line" id="line-88">                llm_manager<span class="token operator">=</span>self<span class="token punctuation">.</span>_llm<span class="token punctuation">,</span></span><span class="code-line" id="line-89">                query_engine <span class="token operator">=</span> query_engine<span class="token punctuation">,</span></span><span class="code-line" id="line-90">                is_web_search<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span></span><span class="code-line" id="line-91">            <span class="token punctuation">)</span></span><span class="code-line" id="line-92"></span><span class="code-line" id="line-93">            <span class="token keyword">async</span> <span class="token keyword">for</span> chunk <span class="token keyword">in</span> generate<span class="token punctuation">.</span>generate_answer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="code-line" id="line-94">                chunk_data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>chunk<span class="token punctuation">)</span></span><span class="code-line" id="line-95">                chunk_data<span class="token punctuation">[</span><span class="token string">"chat_id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>chat_id</span><span class="code-line" id="line-96">                chunk_data<span class="token punctuation">[</span><span class="token string">"metadata"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span><span class="code-line" id="line-97">                    <span class="token string">"model"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_llm<span class="token punctuation">.</span>model_name<span class="token punctuation">,</span></span><span class="code-line" id="line-98">                    <span class="token string">"sources"</span><span class="token punctuation">:</span> chunk_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"text"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">if</span> chunk_data<span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"context"</span> <span class="token keyword">else</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="code-line" id="line-99">                <span class="token punctuation">}</span></span><span class="code-line" id="line-100">                <span class="token keyword">yield</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>chunk_data<span class="token punctuation">)</span></span><span class="code-line" id="line-101">            logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Time taken: </span><span class="token interpolation"><span class="token punctuation">{</span>time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span><span class="code-line" id="line-102">        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></span><span class="code-line" id="line-103">            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span><span class="code-line" id="line-104">            <span class="token keyword">raise</span></span><span class="code-line" id="line-105"></span><span class="code-line" id="line-106">    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">process_rag_report_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> ChatRequest<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> StreamingResponse<span class="token punctuation">:</span></span><span class="code-line" id="line-107">        <span class="token triple-quoted-string string">"""Process a RAG-based report request."""</span></span><span class="code-line" id="line-108">        <span class="token keyword">try</span><span class="token punctuation">:</span></span><span class="code-line" id="line-109">            start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="code-line" id="line-110">            Settings<span class="token punctuation">.</span>_prompt_helper <span class="token operator">=</span> PromptHelper<span class="token punctuation">(</span>context_window<span class="token operator">=</span><span class="token number">20000</span><span class="token punctuation">)</span></span><span class="code-line" id="line-111">            Settings<span class="token punctuation">.</span>llm <span class="token operator">=</span> self<span class="token punctuation">.</span>_llm<span class="token punctuation">.</span>llm_model</span><span class="code-line" id="line-112">            Settings<span class="token punctuation">.</span>embed_model <span class="token operator">=</span> self<span class="token punctuation">.</span>_llm<span class="token punctuation">.</span>embed_model</span><span class="code-line" id="line-113">            self<span class="token punctuation">.</span>_storage_manager<span class="token punctuation">.</span>load_chat_history<span class="token punctuation">(</span>request<span class="token punctuation">.</span>chat_id<span class="token punctuation">)</span></span><span class="code-line" id="line-114">            prompts <span class="token operator">=</span> PromptManager<span class="token punctuation">.</span>load_prompts<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_settings<span class="token punctuation">.</span>get_setting<span class="token punctuation">)</span></span><span class="code-line" id="line-115">            metadata_filters <span class="token operator">=</span> self<span class="token punctuation">.</span>_prepare_metadata_filters<span class="token punctuation">(</span>request<span class="token punctuation">.</span>metadata<span class="token punctuation">)</span></span><span class="code-line" id="line-116">            storage_context_manager <span class="token operator">=</span> StorageContextManager<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_settings<span class="token punctuation">.</span>get_setting<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_settings<span class="token punctuation">.</span>get_secret_value<span class="token punctuation">)</span></span><span class="code-line" id="line-117">            index <span class="token operator">=</span> storage_context_manager<span class="token punctuation">.</span>setup_storage_context<span class="token punctuation">(</span><span class="token string">"documents"</span><span class="token punctuation">)</span></span><span class="code-line" id="line-118"></span><span class="code-line" id="line-119">            queryenginemanager_report <span class="token operator">=</span> QueryEngineManager<span class="token punctuation">(</span></span><span class="code-line" id="line-120">                model_manager<span class="token operator">=</span>self<span class="token punctuation">.</span>_llm<span class="token punctuation">,</span></span><span class="code-line" id="line-121">                prompts<span class="token operator">=</span>prompts<span class="token punctuation">,</span></span><span class="code-line" id="line-122">                config<span class="token operator">=</span>self<span class="token punctuation">.</span>_settings<span class="token punctuation">.</span>get_setting<span class="token punctuation">,</span></span><span class="code-line" id="line-123">                cohere_api_key<span class="token operator">=</span>self<span class="token punctuation">.</span>_settings<span class="token punctuation">.</span>get_secret_value<span class="token punctuation">(</span><span class="token string">"COHERE_API_KEY"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="code-line" id="line-124">                mode<span class="token operator">=</span><span class="token string">"REPORT"</span></span><span class="code-line" id="line-125">            <span class="token punctuation">)</span></span><span class="code-line" id="line-126">            query_engine_report <span class="token operator">=</span> queryenginemanager_report<span class="token punctuation">.</span>build<span class="token punctuation">(</span>index<span class="token punctuation">,</span> metadata_filters<span class="token punctuation">)</span></span><span class="code-line" id="line-127"></span><span class="code-line" id="line-128">            generate_report <span class="token operator">=</span> Generate<span class="token punctuation">(</span></span><span class="code-line" id="line-129">                config<span class="token operator">=</span>self<span class="token punctuation">.</span>_settings<span class="token punctuation">.</span>get_setting<span class="token punctuation">,</span></span><span class="code-line" id="line-130">                secret<span class="token operator">=</span>self<span class="token punctuation">.</span>_settings<span class="token punctuation">.</span>get_secret_value<span class="token punctuation">,</span></span><span class="code-line" id="line-131">                chat_id<span class="token operator">=</span>request<span class="token punctuation">.</span>chat_id<span class="token punctuation">,</span></span><span class="code-line" id="line-132">                query<span class="token operator">=</span>request<span class="token punctuation">.</span>message<span class="token punctuation">,</span></span><span class="code-line" id="line-133">                query_engine <span class="token operator">=</span> query_engine_report<span class="token punctuation">,</span></span><span class="code-line" id="line-134">                is_web_search<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span></span><span class="code-line" id="line-135">            <span class="token punctuation">)</span></span><span class="code-line" id="line-136"></span><span class="code-line" id="line-137">            <span class="token keyword">async</span> <span class="token keyword">for</span> chunk <span class="token keyword">in</span> generate_report<span class="token punctuation">.</span>generate_report<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="code-line" id="line-138">                chunk_data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>chunk<span class="token punctuation">)</span></span><span class="code-line" id="line-139">                <span class="token keyword">yield</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>chunk_data<span class="token punctuation">)</span></span><span class="code-line" id="line-140">        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></span><span class="code-line" id="line-141">            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span><span class="code-line" id="line-142">            <span class="token keyword">raise</span></span></code></pre>
                </div>
            </div>
        </section>
    </main>

    <script>
        const CODE_FILE = `import logging
from typing import Optional, Dict, Any, Generator
from datetime import datetime
from fastapi.responses import StreamingResponse, JSONResponse
import uuid
from ..models.base import ChatMessage, ChatHistory
from ..schemas.api import ChatRequest, ChatResponse
from ..schemas.rag import ChatRAGRequest
from ..managers.storage_manager import LocalStorageManager
from ..managers.llm_manager import LLMManager
from ..managers.query_engine_manager import QueryEngineManager
from ..managers.storage_context_manager import StorageContextManager
from ..managers.prompt_manager import PromptManager
from ..generate import Generate
from typing import Optional, Dict, Generator, List, Any, Union, Tuple, Callable, AsyncGenerator
from llama_index.core.vector_stores import MetadataFilters, MetadataFilter
from llama_index.core import Settings, PromptHelper
import time
import json

logger = logging.getLogger(__name__)


class ChatService:
    """Service for handling chat operations."""
    
    def __init__(self, storage_manager: LocalStorageManager, llm_manager: LLMManager, settings_manager):
        self._storage_manager = storage_manager
        self._llm = llm_manager
        self._settings = settings_manager
    
    def _prepare_metadata_filters(self, metadata: Dict[str, Any]) -> List[MetadataFilter]:
        """Prepare metadata filters from metadata dict."""
        if metadata is None:
            logger.warning("No metadata provided; returning empty filter list.")
            return []  # Return an empty list if no metadata is provided
        logger.info(f"Preparing metadata filters: {metadata}")
        return [MetadataFilter(key=key, value=value) for key, value in metadata.items()]
        
    async def process_chat(self, request: ChatRequest) -> ChatResponse:
        """Process a basic chat request."""
        try:
            self._storage_manager.load_chat_history(request.chat_id)
            response_text = await self._llm.generate_response(request.message)
            self._storage_manager.chat_hist = f"{request.message}\\n{response_text}\\n\\n"
            return ChatResponse(
                chat_id=request.chat_id,
                message=response_text,
                metadata={"model": self._llm.model_name}
            )
        except Exception as e:
            logger.error(f"Error processing chat request: {e}")
            raise

    async def process_rag_chat(self, request: ChatRequest) -> StreamingResponse:
        """Process a RAG-based chat request."""
        try:
            start_time = time.perf_counter()
            logger.info(f"Processing RAG chat request for chat_id: {request.chat_id}")
            Settings._prompt_helper = PromptHelper(context_window=20000)
            Settings.llm = self._llm.llm_model
            Settings.embed_model = self._llm.embed_model
            self._storage_manager.load_chat_history(request.chat_id)
            collection_name="documents"
            prompts = PromptManager.load_prompts(self._settings.get_setting)
            metadata_filters = self._prepare_metadata_filters(request.metadata)
            storage_context_manager = StorageContextManager(self._settings.get_setting, self._settings.get_secret_value)
            index = storage_context_manager.setup_storage_context(collection_name)

            queryenginemanager = QueryEngineManager(
                model_manager=self._llm,
                prompts=prompts,
                config=self._settings.get_setting,
                cohere_api_key=self._settings.get_secret_value("COHERE_API_KEY")
            )
            query_engine = queryenginemanager.build(index, metadata_filters)

            generate = Generate(
                config=self._settings.get_setting,
                secret=self._settings.get_secret_value,
                chat_id=request.chat_id,
                query=request.message,
                category_name=request.metadata.get("category", "general"),
                metadata=request.metadata,
                collection_name=collection_name,
                s3_manager=self._storage_manager,
                storage_manager=self._storage_manager,
                llm_manager=self._llm,
                query_engine = query_engine,
                is_web_search=False,
            )

            async for chunk in generate.generate_answer():
                chunk_data = json.loads(chunk)
                chunk_data["chat_id"] = request.chat_id
                chunk_data["metadata"] = {
                    "model": self._llm.model_name,
                    "sources": chunk_data.get("text", []) if chunk_data["type"] == "context" else []
                }
                yield json.dumps(chunk_data)
            logger.info(f"Time taken: {time.perf_counter() - start_time}")
        except Exception as e:
            logger.error(f"Error: {e}")
            raise

    async def process_rag_report_request(self, request: ChatRequest) -> StreamingResponse:
        """Process a RAG-based report request."""
        try:
            start_time = time.perf_counter()
            Settings._prompt_helper = PromptHelper(context_window=20000)
            Settings.llm = self._llm.llm_model
            Settings.embed_model = self._llm.embed_model
            self._storage_manager.load_chat_history(request.chat_id)
            prompts = PromptManager.load_prompts(self._settings.get_setting)
            metadata_filters = self._prepare_metadata_filters(request.metadata)
            storage_context_manager = StorageContextManager(self._settings.get_setting, self._settings.get_secret_value)
            index = storage_context_manager.setup_storage_context("documents")

            queryenginemanager_report = QueryEngineManager(
                model_manager=self._llm,
                prompts=prompts,
                config=self._settings.get_setting,
                cohere_api_key=self._settings.get_secret_value("COHERE_API_KEY"),
                mode="REPORT"
            )
            query_engine_report = queryenginemanager_report.build(index, metadata_filters)

            generate_report = Generate(
                config=self._settings.get_setting,
                secret=self._settings.get_secret_value,
                chat_id=request.chat_id,
                query=request.message,
                query_engine = query_engine_report,
                is_web_search=False,
            )

            async for chunk in generate_report.generate_report():
                chunk_data = json.loads(chunk)
                yield json.dumps(chunk_data)
        except Exception as e:
            logger.error(f"Error: {e}")
            raise`;

        window.WALKTHROUGH_JSON = [
            {
                "id": 1,
                "title": "Metadata Filters as Pre-Ranking Constraints",
                "description": "This helper converts request-level metadata into LlamaIndex MetadataFilter objects. While not a re-ranker itself, metadata filtering directly constrains the candidate pool before any re-ranking can occur.",
                "codeBlock": "_prepare_metadata_filters",
                "lineRange": [32, 38],
                "label": "Candidate Pre-Filtering"
            },
            {
                "id": 2,
                "title": "Query Engine Construction with Re-ranking",
                "description": "The QueryEngineManager is instantiated with a Cohere API key. The build() call is the critical handoff where the index, metadata filters, and re-ranking strategy are composed into a single query engine.",
                "codeBlock": "QueryEngineManager.build",
                "lineRange": [72, 78],
                "label": "Re-ranking Strategy Injection"
            },
            {
                "id": 3,
                "title": "Standard RAG Query Engine with Re-ranking",
                "description": "In the standard RAG chat flow, the query engine is built once. From this point onward, all document retrievals implicitly include re-ranking if configured in the QueryEngineManager.",
                "codeBlock": "process_rag_chat",
                "lineRange": [54, 108],
                "label": "Re-ranked Retrieval Path"
            },
            {
                "id": 4,
                "title": "Report Mode Specialized Re-ranking",
                "description": "For report generation, the QueryEngineManager is constructed with mode=\"REPORT\", which typically implies a heavier re-ranking configuration (e.g., larger cross-encoders).",
                "codeBlock": "QueryEngineManager(mode=\"REPORT\")",
                "lineRange": [126, 134],
                "label": "Re-ranking Mode Selection"
            },
            {
                "id": 5,
                "title": "Propagation of Re-ranked Nodes",
                "description": "The Generate object receives the fully constructed query engine, meaning any re-ranking decisions have already been applied by the time generation starts.",
                "codeBlock": "Generate(..., query_engine=query_engine)",
                "lineRange": [80, 93],
                "label": "Re-ranked Context Consumption"
            },
            {
                "id": 6,
                "title": "Re-ranking Impact on Streaming",
                "description": "During streaming, context chunks are emitted to the client. These reflect the ordering and selection imposed by the re-ranking layer inside the query engine.",
                "codeBlock": "generate.generate_answer",
                "lineRange": [97, 104],
                "label": "Post-Re-ranking Attribution"
            }
        ];

        let state = {
            activeId: 1,
            isFullMode: false,
            scrolling: false
        };

        const cardsContainer = document.getElementById('cards-container');
        const snippetCode = document.getElementById('snippet-code');
        const snippetLabel = document.getElementById('snippet-label');
        const fullCodeScroll = document.getElementById('full-code-scroll');
        const fullCodeContent = document.getElementById('full-code-content');
        const viewToggle = document.getElementById('view-toggle');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');

        // Initialize Cards
        function renderCards() {
            cardsContainer.innerHTML = WALKTHROUGH_JSON.map(item => `
                <div id="card-${item.id}" 
                     onclick="activateStep(${item.id})"
                     class="card group relative bg-white p-6 rounded-3xl shadow-sm border-2 border-transparent transition-all cursor-pointer hover:shadow-md hover:border-indigo-100 ${state.activeId === item.id ? 'active-card' : ''}">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="flex items-center justify-center w-8 h-8 rounded-full bg-slate-100 text-slate-500 font-bold text-xs group-[.active-card]:bg-indigo-600 group-[.active-card]:text-white transition-colors">
                            ${item.id}
                        </span>
                        <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400 group-[.active-card]:text-indigo-600">${item.label}</span>
                    </div>
                    <h3 class="font-bold text-slate-800 text-lg mb-2 group-[.active-card]:text-indigo-600">${item.title}</h3>
                    <p class="text-sm text-slate-500 leading-relaxed">${item.description}</p>
                    <div class="absolute inset-x-0 bottom-0 h-1 rounded-b-3xl bg-indigo-600 scale-x-0 group-[.active-card]:scale-x-100 transition-transform origin-left"></div>
                </div>
            `).join('');
            
            // Re-apply active class visually
            document.querySelectorAll('.card').forEach(c => {
                const id = parseInt(c.id.split('-')[1]);
                if(id === state.activeId) {
                    c.classList.add('border-indigo-600', 'active-card');
                    c.classList.remove('border-transparent');
                } else {
                    c.classList.remove('border-indigo-600', 'active-card');
                    c.classList.add('border-transparent');
                }
            });
        }

        // Initialize Full Code Content
        function renderFullCode() {
            const lines = CODE_FILE.split('\n');
            fullCodeContent.innerHTML = lines.map((line, idx) => {
                const lineNum = idx + 1;
                return `<span class="code-line" id="line-${lineNum}">${Prism.highlight(line, Prism.languages.python, 'python')}</span>`;
            }).join('');
        }

        window.activateStep = function activateStep(id, fromScroll = false) {
            state.activeId = id;
            const item = WALKTHROUGH_JSON.find(i => i.id === id);
            
            // Update Progress
            const progress = Math.round((id / WALKTHROUGH_JSON.length) * 100);
            progressBar.style.width = `${progress}%`;
            progressText.innerText = `${progress}%`;

            // Update Cards UI
            renderCards();

            // Update Code Pane
            if (!state.isFullMode) {
                const lines = CODE_FILE.split('\n');
                const snippet = lines.slice(item.lineRange[0] - 1, item.lineRange[1]).join('\n');
                snippetCode.innerHTML = Prism.highlight(snippet, Prism.languages.python, 'python');
                snippetLabel.innerText = `${item.label} (Lines ${item.lineRange[0]}-${item.lineRange[1]})`;
            } else {
                // Dim/Highlight Logic
                document.querySelectorAll('.code-line').forEach(line => {
                    const lNum = parseInt(line.id.split('-')[1]);
                    if (lNum >= item.lineRange[0] && lNum <= item.lineRange[1]) {
                        line.classList.add('active');
                        line.classList.remove('dimmed');
                    } else {
                        line.classList.remove('active');
                        line.classList.add('dimmed');
                    }
                });

                if (!fromScroll) {
                    const targetLine = document.getElementById(`line-${item.lineRange[0]}`);
                    targetLine?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            // Sync explanation scroll
            if (fromScroll) {
                const card = document.getElementById(`card-${id}`);
                card?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        viewToggle.onclick = () => {
            state.isFullMode = !state.isFullMode;
            document.getElementById('snippet-container').classList.toggle('hidden', state.isFullMode);
            document.getElementById('full-code-container').classList.toggle('hidden', !state.isFullMode);
            viewToggle.innerText = state.isFullMode ? 'Switch to Logic Blocks' : 'Switch to Full Mode';
            activateStep(state.activeId);
        };

        // Scroll-Sync Implementation
        fullCodeScroll.onscroll = () => {
            if (!state.isFullMode || state.scrolling) return;

            const panelRect = fullCodeScroll.getBoundingClientRect();
            const center = panelRect.top + (panelRect.height / 2);

            let currentStepId = state.activeId;

            WALKTHROUGH_JSON.forEach(item => {
                const lineEl = document.getElementById(`line-${item.lineRange[0]}`);
                if (lineEl) {
                    const rect = lineEl.getBoundingClientRect();
                    // Detect which item is closest to the vertical center of the viewport
                    if (rect.top < center && rect.bottom > center - 200) {
                        currentStepId = item.id;
                    }
                }
            });

            if (currentStepId !== state.activeId) {
                activateStep(currentStepId, true);
            }
        };

        // Init
        window.onload = () => {
            renderCards();
            renderFullCode();
            activateStep(1);
        };
    </script>

    <!-- Audio-guided walkthrough controller -->
    <script>
        (function () {
            if (!window.WALKTHROUGH_JSON || !window.activateStep) return;

            const steps = window.WALKTHROUGH_JSON;
            const audio = new Audio();
            audio.preload = 'auto';

            let currentIndex = 0;
            let isUserPaused = true;

            function audioSrcFor(stepId) {
                // card-1.mp3  card-N.mp3 (matches card IDs)
                return `card-${stepId}.mp3`;
            }

            function loadTrack(index, play = false) {
                currentIndex = Math.max(0, Math.min(steps.length - 1, index));
                const step = steps[currentIndex];
                audio.src = audioSrcFor(step.id);
                try {
                    window.activateStep(step.id);
                    // Scroll the active card into view, centered in viewport
                    const activeCard = document.getElementById(`card-${step.id}`);
                    if (activeCard) {
                        activeCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                } catch (e) {
                    // ignore if activateStep not ready yet
                }
                if (play) {
                    playCurrent();
                } else {
                    isUserPaused = true;
                    updatePlayIcon();
                }
            }

            function playCurrent() {
                isUserPaused = false;
                audio.play().catch(function () {
                    isUserPaused = true;
                    updatePlayIcon();
                });
                updatePlayIcon();
            }

            function pauseCurrent() {
                isUserPaused = true;
                audio.pause();
                updatePlayIcon();
            }

            function nextTrack() {
                if (currentIndex < steps.length - 1) {
                    loadTrack(currentIndex + 1, !isUserPaused);
                } else {
                    pauseCurrent();
                }
            }

            function prevTrack() {
                if (currentIndex > 0) {
                    loadTrack(currentIndex - 1, !isUserPaused);
                } else {
                    loadTrack(0, !isUserPaused);
                }
            }

            // UI
            const bar = document.createElement('div');
            bar.id = 'code-audio-controller';
            bar.style.position = 'fixed';
            bar.style.left = '50%';
            bar.style.transform = 'translateX(-50%)';
            bar.style.bottom = '18px';
            bar.style.zIndex = '40';
            bar.style.background = '#0f172a';
            bar.style.color = '#e5e7eb';
            bar.style.borderRadius = '999px';
            bar.style.padding = '8px 18px';
            bar.style.display = 'flex';
            bar.style.alignItems = 'center';
            bar.style.gap = '10px';
            bar.style.boxShadow = '0 12px 30px rgba(15,23,42,0.55)';
            bar.style.fontFamily = 'system-ui, -apple-system, BlinkMacSystemFont, sans-serif';
            bar.innerHTML = `
                <button id="code-audio-prev" style="background:none;border:none;color:#e5e7eb;cursor:pointer;font-size:14px;"></button>
                <button id="code-audio-play" style="width:32px;height:32px;border-radius:999px;border:none;background:#22c55e;color:#022c22;font-weight:900;cursor:pointer;"></button>
                <button id="code-audio-next" style="background:none;border:none;color:#e5e7eb;cursor:pointer;font-size:14px;"></button>
                <div style="min-width:180px;">
                    <div id="code-audio-label" style="font-size:11px;text-transform:uppercase;letter-spacing:0.15em;color:#a5b4fc;">Step 1</div>
                    <div style="width:100%;height:4px;border-radius:999px;background:#1e293b;overflow:hidden;margin-top:4px;">
                        <div id="code-audio-progress" style="height:100%;width:0%;background:#22c55e;"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(bar);

            const playBtn = document.getElementById('code-audio-play');
            const prevBtn = document.getElementById('code-audio-prev');
            const nextBtn = document.getElementById('code-audio-next');
            const label = document.getElementById('code-audio-label');
            const progress = document.getElementById('code-audio-progress');

            function updatePlayIcon() {
                playBtn.textContent = isUserPaused ? '' : '';
            }

            function updateLabel() {
                const step = steps[currentIndex];
                label.textContent = `${step.label || step.title || 'Step'}  ${currentIndex + 1}/${steps.length}`;
            }

            playBtn.addEventListener('click', function () {
                if (isUserPaused) {
                    playCurrent();
                } else {
                    pauseCurrent();
                }
            });
            prevBtn.addEventListener('click', prevTrack);
            nextBtn.addEventListener('click', nextTrack);

            audio.addEventListener('timeupdate', function () {
                if (!audio.duration) return;
                const pct = (audio.currentTime / audio.duration) * 100;
                progress.style.width = pct + '%';
            });

            audio.addEventListener('ended', function () {
                nextTrack();
            });

            // Initialize first step without autoplay
            loadTrack(0, false);
            updateLabel();
        })();
    </script>

</body></html>